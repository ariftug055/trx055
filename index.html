<!DOCTYPE html>
<html>
<head>
    <title>FİYAT HESAPLA</title>
    <style>
        /* CSS Değişkenleri - Kolay Özelleştirme İçin */
        :root {
            --color-primary: #1a73e8; /* Google'ın materyal mavisi */
            --color-secondary: #34a853; /* Google'ın materyal yeşili */
            --color-accent: #ea4335; /* Google'ın materyal kırmızısı */
            --color-text-dark: #202124;
            --color-text-medium: #5f6368;
            --color-text-light: #f8f8f8;
            --color-background: #f8f9fa; /* Çok açık gri arkaplan */
            --color-card-background: #ffffff;
            --color-border-light: #dadce0; /* Hafif, modern kenarlık */
            --color-border-dark: #c1c1c1;
            --color-shadow-light: rgba(60, 64, 67, 0.1); /* Hafif gölge */
            --color-shadow-medium: rgba(60, 64, 67, 0.15); /* Orta gölge */
            --font-family-main: 'Inter', sans-serif; /* Modern, clean font */
            --spacing-xs: 8px;
            --spacing-sm: 16px;
            --spacing-md: 24px;
            --spacing-lg: 32px;
            --border-radius-sm: 8px;
            --border-radius-md: 16px;
        }

        /* Inter fontunu Google Fonts'tan dahil etme */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap'); /* 800 bold'u da ekledik */

        body {
            font-family: var(--font-family-main);
            margin: 0;
            padding: var(--spacing-lg);
            background-color: var(--color-background);
            color: var(--color-text-dark);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        h1 {
            color: var(--color-primary);
            font-size: 2.8em;
            margin-bottom: var(--spacing-lg);
            text-align: center;
            font-weight: 800; /* Daha da kalın başlık */
            letter-spacing: -0.8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        h2 {
            color: var(--color-text-dark);
            font-size: 1.8em;
            border-bottom: 2px solid var(--color-border-light);
            padding-bottom: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            font-weight: 700; /* Daha belirgin alt başlık */
            line-height: 1.3;
        }

        #app-container {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: var(--spacing-lg);
            width: 100%;
            max-width: 1400px;
        }

        .card {
            background-color: var(--color-card-background);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-md);
            box-shadow: 0 10px 30px var(--color-shadow-light);
            transition: transform 0.3s ease-out, box-shadow 0.3s ease-out;
        }
        .card:hover {
            transform: translateY(-7px);
            box-shadow: 0 15px 40px var(--color-shadow-medium);
        }

        .form-section {
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-md);
            border: 1px solid var(--color-border-light);
            border-radius: var(--border-radius-sm);
            background-color: #fcfcfc;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .form-section:last-of-type {
            margin-bottom: 0;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
        }
        .form-row.full-width {
            grid-template-columns: 1fr;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        label {
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
            font-size: 0.95em;
            color: var(--color-text-medium);
            transition: color 0.3s ease;
        }

        input[type="text"],
        input[type="number"],
        select { /* select için de stil eklendi */
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--color-border-dark);
            border-radius: var(--border-radius-sm);
            font-size: 1.05em;
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
            background-color: #ffffff;
            appearance: none; /* Varsayılan select stilini kaldırır */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007bff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13%205.7L146.2%20202.7%2018.5%2075.1a17.6%2017.6%200%200%200-24.7%2024.7l130.4%20130.4c6.6%206.6%2017.4%206.6%2024%200l130.4-130.4a17.6%2017.6%200%200%200-12.9-30.5z%22%2F%3E%3C%2Fsvg%3E'); /* Özel aşağı ok */
            background-repeat: no-repeat;
            background-position: right var(--spacing-sm) center;
            background-size: 12px;
            padding-right: calc(var(--spacing-sm) * 2 + 12px); /* Ok için boşluk */
        }
        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus { /* select için de stil eklendi */
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 5px rgba(26, 115, 232, 0.2);
            background-color: #faffe0;
        }
        
        input::placeholder {
            color: #aab2bd;
            opacity: 1;
        }

        .waypoint-input {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
        }
        .waypoint-input input { flex-grow: 1; }
        .waypoint-input button {
            background-color: var(--color-accent);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.3s ease;
            flex-shrink: 0;
            opacity: 0.9;
        }
        .waypoint-input button:hover {
            background-color: #d13023;
            opacity: 1;
        }

        #addWaypoint {
            background-color: var(--color-secondary);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-weight: 500;
            display: block;
            width: 100%;
            margin-top: var(--spacing-sm);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #addWaypoint:hover {
            background-color: #2e8b4e;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }

        #returnTripSection {
            border: 1px dashed var(--color-border-dark);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-sm);
            background-color: #fefefe;
            margin-top: var(--spacing-md);
        }
        #returnTripSection label {
            display: flex;
            align-items: center;
            margin-bottom: var(--spacing-sm);
            font-size: 1em;
            font-weight: 600;
            color: var(--color-text-dark);
        }
        #returnTripSection input[type="checkbox"] {
            width: auto;
            margin-right: var(--spacing-sm);
            transform: scale(1.4);
            accent-color: var(--color-primary);
            cursor: pointer;
        }
        #returnTripSection .form-group {
            margin-top: var(--spacing-sm);
        }
        #returnTripSection #returnFuelInputGroup {
            display: none;
            margin-top: var(--spacing-sm);
        }
        #returnTripSection #returnFuelInputGroup.active {
            display: flex;
        }
        
        /* Manuel Köprü Ücreti Alanı */
        #tollFeeAdjustableGroup { /* Yeni grup için id */
            display: none; /* Başlangıçta gizli */
            margin-top: var(--spacing-md);
            border-top: 1px dashed var(--color-border-light);
            padding-top: var(--spacing-md);
        }
        #tollFeeAdjustableGroup.active {
            display: flex; /* 'active' class'ı eklendiğinde göster */
        }
        #tollFeeAdjustableGroup .form-group { /* İçindeki form-group'u flex yapısını bozmadan düzeltme */
            width: 100%;
        }


        button[type="submit"] {
            padding: var(--spacing-md) var(--spacing-lg);
            background-color: var(--color-primary);
            color: var(--color-text-light);
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 1.3em;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            margin-top: var(--spacing-md);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
            width: 100%;
        }
        button[type="submit"]:hover {
            background-color: #1565c0;
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        button[type="submit"]:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        #map {
            height: 700px;
            width: 100%;
            border: 1px solid var(--color-border-light);
            border-radius: var(--border-radius-md);
            box-shadow: 0 10px 30px var(--color-shadow-light);
        }
        
        #results {
            width: 100%;
            max-width: 1400px;
            margin-top: var(--spacing-lg);
            visibility: hidden;
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out, visibility 0.6s;
        }

        #results.visible {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            padding: var(--spacing-sm) 0;
            border-bottom: 1px solid var(--color-border-light);
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .result-item strong {
            color: var(--color-text-dark);
            font-weight: 500;
            font-size: 1.05em;
        }
        .result-value {
            font-weight: 700;
            color: var(--color-primary);
            font-size: 1.3em;
            text-align: right;
            letter-spacing: -0.2px;
        }
        .summary-results .result-value {
            font-size: 1.8em;
            color: var(--color-accent);
            font-weight: 800;
            text-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .summary-results .result-item {
            padding: var(--spacing-lg) 0;
        }

        hr {
            border: 0;
            height: 1px;
            background: var(--color-border-dark);
            margin: var(--spacing-md) 0;
        }

        /* Duyarlı Tasarım */
        @media (max-width: 992px) {
            #app-container {
                grid-template-columns: 1fr;
            }
            form {
                gap: var(--spacing-sm);
            }
            .form-row {
                grid-template-columns: 1fr;
                gap: var(--spacing-sm);
            }
            #map {
                height: 300px;
            }
            h1 {
                font-size: 2.2em;
                margin-bottom: var(--spacing-md);
            }
            body {
                padding: var(--spacing-md);
            }
            .card {
                padding: var(--spacing-md);
            }
            button[type="submit"] {
                font-size: 1.2em;
                padding: var(--spacing-sm) var(--spacing-md);
            }
            .form-section {
                padding: var(--spacing-sm);
            }
            #results {
                margin-top: var(--spacing-md);
            }
            .summary-results .result-value {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <h1>NAKLİYE FİYATI HESAPLAMA ARACI</h1>

    <div id="app-container">
        <div class="card">
            <form id="costForm">
                <div class="form-section">
                    <h2>Rota Bilgileri</h2>
                    <div class="form-row full-width">
                        <div class="form-group">
                            <label for="origin">Başlangıç Noktası</label>
                            <input type="text" id="origin" placeholder="Örn: Ankara" required>
                        </div>
                    </div>
                    <div class="form-row full-width">
                        <div class="form-group">
                            <label for="destination">Bitiş Noktası</label>
                            <input type="text" id="destination" placeholder="Örn: Samsun" required>
                        </div>
                    </div>
                    <div class="form-row full-width">
                        <div class="form-group">
                            <label>Ara Duraklar</label>
                            <div id="waypointsContainer">
                                </div>
                            <button type="button" id="addWaypoint">+ Ara Durak Ekle</button>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2>Süre ve Maliyet Parametreleri</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="loadingTime">Yükleme Süresi (saat)</label>
                            <input type="number" id="loadingTime" value="1" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="unloadingTime">İndirme Süresi (saat)</label>
                            <input type="number" id="unloadingTime" value="1" min="0" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dailyTruckFixedCostInput">Günlük Araç Sabit Maliyeti (TL)</label>
                            <input type="number" id="dailyTruckFixedCostInput" value="5900" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="otherDailyFixedCostInput">Diğer Sabit Giderler (Günlük, TL)</label>
                            <input type="number" id="otherDailyFixedCostInput" value="0" min="0" step="0.01" required>
                        </div>
                    </div>
                     <div class="form-row">
                        <div class="form-group">
                            <label for="averageSpeed">Ortalama Sürüş Hızı (km/sa)</label>
                            <input type="number" id="averageSpeed" value="75" min="1" step="0.01" required>
                        </div>
                         <div class="form-group">
                            <label for="tollBridgeSelect">Tahmini Otoyol/Köprü Seçimi</label>
                            <select id="tollBridgeSelect" required>
                                <option value="none">Hiçbiri / Yok</option>
                                <option value="15Temmuz">15 Temmuz Şehitler Köprüsü</option>
                                <option value="FSM">Fatih Sultan Mehmet Köprüsü</option>
                                <option value="YSS">Yavuz Sultan Selim Köprüsü</option>
                                <option value="Osmangazi">Osmangazi Köprüsü</option>
                                <option value="1915Canakkale">1915 Çanakkale Köprüsü</option>
                                <option value="manual">Diğer (Manuel Giriş)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row full-width" id="tollFeeAdjustableGroup">
                        <div class="form-group">
                            <label for="currentTollFeeInput">Köprü/Otoyol Ücreti (TL) <span id="tollFeeNote"></span></label>
                            <input type="number" id="currentTollFeeInput" value="0" min="0" step="0.01" required>
                        </div>
                    </div>

                    <div class="form-row full-width">
                        <div class="form-group">
                            <label for="truckTonnageInput">Araç Tonaj Kapasitesi (Ton)</label>
                            <input type="number" id="truckTonnageInput" value="26" min="1" step="0.01" required>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2>Yakıt ve Kar Bilgileri</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dieselPriceInput">Motorin Litre Fiyatı (TL)</label>
                            <input type="number" id="dieselPriceInput" value="47" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="fuelConsumptionInput">100 km'de Yakıt (Litre)</label>
                            <input type="number" id="fuelConsumptionInput" value="36" min="0" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="profitMarginInput">Kar Oranı (%)</label>
                            <input type="number" id="profitMarginInput" value="40" min="0" step="0.01" required>
                        </div>
                        <div></div>
                    </div>
                    <div id="returnTripSection">
                        <label>
                            <input type="checkbox" id="includeReturnTrip" checked>
                            Dönüş Yolu Maliyetini Dahil Et
                        </label>
                        <div class="form-group" id="returnFuelInputGroup">
                            <label for="returnTripEmptyFuelConsumption">Dönüş Yolu Boş Yakıt Tük. (100km'de Litre)</label>
                            <input type="number" id="returnTripEmptyFuelConsumption" value="28" min="0" step="0.01" required>
                        </div>
                    </div>
                </div>
                
                <button type="submit">Maliyet ve Karı Hesapla</button>
            </form>
        </div>

        <div id="map" class="card"></div>
    </div>

    <div id="results" class="card">
        <h2>Hesaplama Sonuçları:</h2>
        <div class="result-item">
            <strong>Rota Mesafesi (Gidiş):</strong> <span id="distance" class="result-value"></span>
        </div>
        <div class="result-item">
            <strong>Google Tahmini Sürüş Süresi:</strong> <span id="googleTravelDuration" class="result-value"></span>
        </div>
        <div class="result-item">
            <strong>Molalar Dahil Tahmini Sürüş Süresi:</strong> <span id="calculatedTravelDurationWithBreaks" class="result-value"></span>
        </div>
        <div class="result-item">
            <strong>Toplam Operasyon Süresi (Yükleme/İndirme Dahil):</strong> <span id="totalOperationDuration" class="result-value"></span>
        </div>
        <div class="result-item">
            <strong>Yakıt Maliyeti (Gidiş):</strong> <span id="fuelCost" class="result-value"></span>
        </div>
        <div class="result-item">
            <strong>Operasyon Süresine Göre Araç Sabit Maliyeti (Gidiş):</strong> <span id="hourlyCost" class="result-value"></span>
        </div>
        <div class="result-item">
            <strong>Dönüş Yolu Maliyeti (Tahmini):</strong> <span id="returnTripCost" class="result-value"></span>
        </div>
        <hr>
        <div class="result-item">
            <strong>Kar Öncesi Temel Operasyonel Maliyet:</strong> <span id="baseOperationalCostOutput" class="result-value"></span>
        </div>
        <div class="result-item">
            <strong>Kar Dahil Operasyonel Fiyat:</strong> <span id="priceBeforeExtraCostsOutput" class="result-value"></span>
        </div>
        <div class="result-item">
            <strong>Eklenen Otoyol/Köprü Ücretleri:</strong> <span id="tollFeeOutput" class="result-value"></span>
        </div>
        <div class="result-item">
            <strong>Eklenen Diğer Sabit Giderler:</strong> <span id="otherDailyFixedCostOutput" class="result-value"></span>
        </div>
        <hr>
        <div class="result-item summary-results">
            <strong>Toplam Tahmini Araç Maliyeti:</strong> <span id="totalCost" class="result-value"></span>
        </div>
        <div class="result-item summary-results">
            <strong>Kar Dahil Nihai Fiyat:</strong> <span id="finalPriceWithProfit" class="result-value"></span>
        </div>
        <div class="result-item summary-results">
            <strong>Ton Başına Maliyet (Kar Dahil):</strong> <span id="pricePerTon" class="result-value"></span>
        </div>
    </div>

    <script>
        let map;
        let directionsService;
        let directionsRenderer;
        let waypointCount = 0;

        // API anahtarınızı buraya girin!
        const GOOGLE_API_KEY = 'AIzaSyD-l-Nep9OY0HyGIe074LmZVFazxXqCLX8'; 

        const MAX_DRIVE_HOURS_PER_DAY = 9; // Saat - Bir tırın günlük yasal sürüş süresi
        const BREAK_DURATION_MINUTES = 45; // Dakika - Her 4.5 saat sürüş sonrası mola süresi
        const DRIVING_INTERVAL_BEFORE_BREAK_HOURS = 4.5; // Saat - Mola öncesi sürüş süresi

        // Yıl sonu güncellenecek köprü ücretleri
        // Bu objeyi sadece ücretler değiştiğinde güncelleyebilirsiniz.
        const bridgeTolls = {
            'none': 0,
            '15Temmuz': 351.00,
            'FSM': 351.00,
            'YSS': 630.00,
            'Osmangazi': 2530.00,
            '1915Canakkale': 3755.00
        };

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 7,
                center: { lat: 39.0, lng: 35.0 } // Türkiye'nin yaklaşık merkezi
            });
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({ map: map });
            toggleReturnFuelInput(); 
            initializeAutocomplete(); // Adres tamamlama başlat
            setupTollBridgeSelection(); // Yeni: Köprü seçimini ayarla
        }

        function initializeAutocomplete() {
            const originInput = document.getElementById('origin');
            const destinationInput = document.getElementById('destination');

            new google.maps.places.Autocomplete(originInput, { componentRestrictions: { country: 'tr' } });
            new google.maps.places.Autocomplete(destinationInput, { componentRestrictions: { country: 'tr' } });

            // Ara duraklar için dinamik autocomplete
            document.getElementById('waypointsContainer').addEventListener('DOMNodeInserted', function(event) {
                if (event.target.classList && event.target.classList.contains('waypoint-input')) {
                    const inputField = event.target.querySelector('.waypoint-input-field');
                    if (inputField) {
                        new google.maps.places.Autocomplete(inputField, { componentRestrictions: { country: 'tr' } });
                    }
                }
            });
        }


        document.getElementById('addWaypoint').addEventListener('click', function() {
            const container = document.getElementById('waypointsContainer');
            const newWaypointDiv = document.createElement('div');
            newWaypointDiv.classList.add('waypoint-input');
            const newWaypointInput = document.createElement('input');
            newWaypointInput.type = 'text';
            newWaypointInput.classList.add('waypoint-input-field');
            newWaypointInput.placeholder = `Ara Durak ${waypointCount + 1}`;
            newWaypointInput.required = true; // Dinamik olarak eklenen inputlara da required ekledik

            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.classList.add('remove-waypoint');
            removeButton.textContent = 'X';

            newWaypointDiv.appendChild(newWaypointInput);
            newWaypointDiv.appendChild(removeButton);
            container.appendChild(newWaypointDiv);
            waypointCount++;

            // Yeni eklenen input için autocomplete'i başlat
            new google.maps.places.Autocomplete(newWaypointInput, { componentRestrictions: { country: 'tr' } });

            removeButton.addEventListener('click', function() {
                container.removeChild(newWaypointDiv);
                waypointCount--;
                // Placeholder numaralarını güncelle
                Array.from(container.children).forEach((el, index) => {
                    el.querySelector('.waypoint-input-field').placeholder = `Ara Durak ${index + 1}`;
                });
            });
        });

        document.getElementById('includeReturnTrip').addEventListener('change', toggleReturnFuelInput);

        function toggleReturnFuelInput() {
            const includeReturnTrip = document.getElementById('includeReturnTrip').checked;
            const returnFuelInputGroup = document.getElementById('returnFuelInputGroup');
            if (includeReturnTrip) {
                returnFuelInputGroup.classList.add('active');
                returnFuelInputGroup.querySelector('input').setAttribute('required', 'required');
            } else {
                returnFuelInputGroup.classList.remove('active');
                returnFuelInputGroup.querySelector('input').removeAttribute('required');
            }
        }

        // --- Yeni Fonksiyon: Köprü Seçimi ve Dinamik Ücret Mantığı ---
        function setupTollBridgeSelection() {
            const tollBridgeSelect = document.getElementById('tollBridgeSelect');
            const tollFeeAdjustableGroup = document.getElementById('tollFeeAdjustableGroup');
            const currentTollFeeInput = document.getElementById('currentTollFeeInput');
            const tollFeeNote = document.getElementById('tollFeeNote'); // Yeni not alanı

            function updateTollFeeInput() {
                const selectedBridge = tollBridgeSelect.value;

                if (selectedBridge === 'none') {
                    tollFeeAdjustableGroup.classList.remove('active');
                    currentTollFeeInput.value = 0;
                    currentTollFeeInput.disabled = true;
                    currentTollFeeInput.required = false;
                    tollFeeNote.textContent = '';
                } else if (selectedBridge === 'manual') {
                    tollFeeAdjustableGroup.classList.add('active');
                    currentTollFeeInput.value = 0; // Manuel girişte başlangıç değeri sıfırla
                    currentTollFeeInput.disabled = false;
                    currentTollFeeInput.required = true;
                    currentTollFeeInput.focus();
                    tollFeeNote.textContent = '(Manuel Giriş)';
                } else {
                    // Köprü seçildi, ücreti getir ve düzenlenebilir yap
                    const fee = bridgeTolls[selectedBridge];
                    currentTollFeeInput.value = fee;
                    currentTollFeeInput.disabled = false;
                    currentTollFeeInput.required = true;
                    tollFeeAdjustableGroup.classList.add('active');
                    tollFeeNote.textContent = `(2025 Güncel)`; // Güncel olduğu bilgisini ver
                }
            }

            tollBridgeSelect.addEventListener('change', updateTollFeeInput);
            updateTollFeeInput(); // Sayfa yüklendiğinde varsayılan durumu ayarla (none seçili olmalı)
        }
        // --- Fonksiyon Sonu ---


        // --- Yeni Fonksiyon: Sayı Formatlama ---
        function formatCurrency(amount) {
            // Türkiye yerel ayarları için number formatlama
            // minimumFractionDigits ve maximumFractionDigits ile ondalık basamak sayısını sabitleriz
            return new Intl.NumberFormat('tr-TR', {
                style: 'currency',
                currency: 'TRY', // Türk Lirası
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function formatNumber(num, decimalPlaces = 0) {
            // Sadece sayıları formatlamak için (mesafe, süre vb.)
            // decimalPlaces parametresi ile ondalık basamak sayısını belirleyebiliriz
            return new Intl.NumberFormat('tr-TR', {
                minimumFractionDigits: decimalPlaces,
                maximumFractionDigits: decimalPlaces
            }).format(num);
        }
        // --- Fonksiyon Sonu ---

        document.getElementById('costForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const origin = document.getElementById('origin').value.trim();
            const destination = document.getElementById('destination').value.trim();
            const loadingTime = parseFloat(document.getElementById('loadingTime').value) || 0;
            const unloadingTime = parseFloat(document.getElementById('unloadingTime').value) || 0;
            const dailyTruckFixedCost = parseFloat(document.getElementById('dailyTruckFixedCostInput').value) || 0;
            
            // Köprü ücretini manuel giriş veya seçilen köprü ücretinden al
            const tollFee = parseFloat(document.getElementById('currentTollFeeInput').value) || 0;

            const otherDailyFixedCost = parseFloat(document.getElementById('otherDailyFixedCostInput').value) || 0;
            const dieselPricePerLiter = parseFloat(document.getElementById('dieselPriceInput').value) || 0;
            const fuelConsumptionPer100Km = parseFloat(document.getElementById('fuelConsumptionInput').value) || 0;
            const truckTonnageCapacity = parseFloat(document.getElementById('truckTonnageInput').value) || 0;
            const profitMargin = parseFloat(document.getElementById('profitMarginInput').value) || 0;
            const averageSpeed = parseFloat(document.getElementById('averageSpeed').value) || 0;

            const includeReturnTrip = document.getElementById('includeReturnTrip').checked;
            let returnTripEmptyFuelConsumption = 0;
            if (includeReturnTrip) {
                returnTripEmptyFuelConsumption = parseFloat(document.getElementById('returnTripEmptyFuelConsumption').value) || 0;
            }

            // --- Giriş Doğrulamaları ---
            if (!origin || !destination) {
                alert('Başlangıç ve Bitiş noktaları boş bırakılamaz.');
                return;
            }
            if (isNaN(loadingTime) || isNaN(unloadingTime) || isNaN(dailyTruckFixedCost) || isNaN(otherDailyFixedCost) ||
                isNaN(dieselPricePerLiter) || isNaN(fuelConsumptionPer100Km) ||
                isNaN(truckTonnageCapacity) || isNaN(profitMargin) || isNaN(tollFee) ||
                isNaN(averageSpeed) || loadingTime < 0 || unloadingTime < 0 ||
                dailyTruckFixedCost < 0 || otherDailyFixedCost < 0 || dieselPricePerLiter < 0 || fuelConsumptionPer100Km < 0 ||
                truckTonnageCapacity <= 0 || profitMargin < 0 || tollFee < 0 || averageSpeed <= 0) {
                alert('Lütfen tüm alanlara geçerli, pozitif sayısal değerler girin. Tonaj kapasitesi ve Ortalama Hız 0\'dan büyük olmalıdır.');
                return;
            }
            if (includeReturnTrip && (isNaN(returnTripEmptyFuelConsumption) || returnTripEmptyFuelConsumption < 0)) {
                alert('Dönüş yolu maliyeti dahil edildiğinde, boş yakıt tüketimi geçerli bir sayı olmalıdır.');
                return;
            }
            // --- Doğrulama Sonu ---

            // Günlük araç sabit maliyetini saatlik maliyete çeviriyoruz.
            const HOURLY_TRUCK_FIXED_COST = dailyTruckFixedCost / MAX_DRIVE_HOURS_PER_DAY;


            const waypoints = [];
            document.querySelectorAll('.waypoint-input-field').forEach(input => {
                const waypointValue = input.value.trim();
                if (waypointValue) {
                    waypoints.push({ location: waypointValue });
                }
            });

            const request = {
                origin: origin,
                destination: destination,
                waypoints: waypoints,
                travelMode: google.maps.TravelMode.DRIVING
            };

            const resultsElement = document.getElementById('results');

            directionsService.route(request, function(result, status) {
                if (status === google.maps.DirectionsStatus.OK) {
                    directionsRenderer.setDirections(result);

                    const route = result.routes[0];
                    let totalDistanceInMeters = 0;
                    let googleTotalTravelDurationInSeconds = 0;

                    route.legs.forEach(leg => {
                        totalDistanceInMeters += leg.distance.value;
                        googleTotalTravelDurationInSeconds += leg.duration.value;
                    });
                    
                    const distanceInKm = totalDistanceInMeters / 1000;
                    
                    const calculatedTravelDurationInHours = distanceInKm / averageSpeed;
                    
                    // --- Molaları ve Dinlenme Sürelerini Hesapla ---
                    const numberOfDrivingIntervals = Math.floor(calculatedTravelDurationInHours / DRIVING_INTERVAL_BEFORE_BREAK_HOURS);
                    const totalBreakDurationHours = numberOfDrivingIntervals * (BREAK_DURATION_MINUTES / 60);

                    const calculatedTravelDurationWithBreaks = calculatedTravelDurationInHours + totalBreakDurationHours;
                    // --- Molalar Hesaplama Sonu ---

                    const totalOperationDurationInHours = calculatedTravelDurationWithBreaks + loadingTime + unloadingTime;

                    document.getElementById('distance').textContent = `${formatNumber(distanceInKm, 0)} km`;
                    document.getElementById('googleTravelDuration').textContent = `${formatNumber(googleTotalTravelDurationInSeconds / 60, 0)} dakika (${formatNumber(googleTotalTravelDurationInSeconds / 3600, 1)} saat)`;
                    document.getElementById('calculatedTravelDurationWithBreaks').textContent = `${formatNumber(calculatedTravelDurationWithBreaks, 1)} saat`;
                    document.getElementById('totalOperationDuration').textContent = `${formatNumber(totalOperationDurationInHours, 1)} saat`;

                    const fuelNeededPerKm = fuelConsumptionPer100Km / 100;
                    const totalFuelConsumed = distanceInKm * fuelNeededPerKm;
                    const totalFuelCost = totalFuelConsumed * dieselPricePerLiter;
                    document.getElementById('fuelCost').textContent = formatCurrency(totalFuelCost);

                    // Operasyon süresine göre araç sabit maliyetini hesapla
                    const calculatedHourlyTruckFixedCost = totalOperationDurationInHours * HOURLY_TRUCK_FIXED_COST;
                    document.getElementById('hourlyCost').textContent = formatCurrency(calculatedHourlyTruckFixedCost);

                    // Dönüş yolu maliyeti (varsa)
                    let totalReturnTripCost = 0;
                    if (includeReturnTrip) {
                        let returnTripFuelCost = 0;
                        if (returnTripEmptyFuelConsumption > 0) {
                            const returnFuelNeededPerKm = returnTripEmptyFuelConsumption / 100;
                            const returnTotalFuelConsumed = distanceInKm * returnFuelNeededPerKm;
                            returnTripFuelCost = returnTotalFuelConsumed * dieselPricePerLiter;
                        }
                        const returnTripHourlyCost = calculatedTravelDurationInHours * HOURLY_TRUCK_FIXED_COST; // Dönüşte de araç sabit maliyeti aynı
                        totalReturnTripCost = returnTripFuelCost + returnTripHourlyCost;
                    }
                    document.getElementById('returnTripCost').textContent = formatCurrency(totalReturnTripCost);

                    // KAR EKLENECEK TEMEL OPERASYONEL MALİYET
                    // Yakıt, aracın sabit maliyeti ve dönüş yolu maliyetini içerir.
                    const baseOperationalCost = totalFuelCost + calculatedHourlyTruckFixedCost + totalReturnTripCost;
                    document.getElementById('baseOperationalCostOutput').textContent = formatCurrency(baseOperationalCost);

                    // KAR DAHİL OPERASYONEL FİYAT (Ekstra maliyetler hariç)
                    const priceBeforeExtraCosts = baseOperationalCost * (1 + (profitMargin / 100));
                    document.getElementById('priceBeforeExtraCostsOutput').textContent = formatCurrency(priceBeforeExtraCosts);
                    
                    // Ekstra maliyetler (bunlara kar uygulanmıyor)
                    // "Diğer Sabit Giderler" günlük girildiği için, bunu operasyon süresine oranlıyoruz
                    const additionalDailyFixedCost = (otherDailyFixedCost / MAX_DRIVE_HOURS_PER_DAY) * totalOperationDurationInHours; 

                    document.getElementById('tollFeeOutput').textContent = formatCurrency(tollFee);
                    document.getElementById('otherDailyFixedCostOutput').textContent = formatCurrency(additionalDailyFixedCost);

                    // NİHAİ FİYAT: Kar eklenmiş operasyonel maliyet + Ekstra maliyetler
                    const finalPriceWithProfit = priceBeforeExtraCosts + tollFee + additionalDailyFixedCost;
                    document.getElementById('finalPriceWithProfit').textContent = formatCurrency(finalPriceWithProfit);

                    // Toplam Tahmini Araç Maliyeti (sadece bilgilendirme amaçlı, kar eklenmemiş, tüm maliyetler)
                    const totalTruckCost = baseOperationalCost + tollFee + additionalDailyFixedCost;
                    document.getElementById('totalCost').textContent = formatCurrency(totalTruckCost);

                    let pricePerTon = 0;
                    if (truckTonnageCapacity > 0) {
                        pricePerTon = finalPriceWithProfit / truckTonnageCapacity;
                    }
                    document.getElementById('pricePerTon').textContent = formatCurrency(pricePerTon) + ' / Ton';
                    
                    resultsElement.classList.add('visible');
                    resultsElement.scrollIntoView({ behavior: 'smooth', block: 'start' });

                } else {
                    alert('Rota bulunamadı veya bir hata oluştu: ' + status + '\nLütfen girilen adresleri kontrol edin.');
                    // Hata durumunda sonuçları sıfırla ve gizle
                    document.getElementById('distance').textContent = '';
                    document.getElementById('googleTravelDuration').textContent = '';
                    document.getElementById('calculatedTravelDurationWithBreaks').textContent = '';
                    document.getElementById('totalOperationDuration').textContent = '';
                    document.getElementById('fuelCost').textContent = '';
                    document.getElementById('hourlyCost').textContent = '';
                    document.getElementById('tollFeeOutput').textContent = '';
                    document.getElementById('returnTripCost').textContent = '';
                    document.getElementById('totalCost').textContent = '';
                    document.getElementById('finalPriceWithProfit').textContent = '';
                    document.getElementById('pricePerTon').textContent = '';
                    resultsElement.classList.remove('visible');
                }
            });
        });
        document.addEventListener('DOMContentLoaded', function() {
            toggleReturnFuelInput();
            setupTollBridgeSelection(); // Sayfa yüklendiğinde köprü seçimini ayarla
        });
    </script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD-l-Nep9OY0HyGIe074LmZVFazxXqCLX8&libraries=places&callback=initMap"></script>
</body>
</html>