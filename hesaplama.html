<!DOCTYPE html>
<html>
<head>
    <title>FİYAT HESAPLA</title>
    <style>
        /* CSS Değişkenleri - Kolay Özelleştirme İçin */
        :root {
            --color-primary: #1a73e8; /* Google'ın materyal mavisi */
            --color-secondary: #34a853; /* Google'ın materyal yeşili */
            --color-accent: #ea4335; /* Google'ın materyal kırmızısı */
            --color-text-dark: #202124;
            --color-text-medium: #5f6368;
            --color-text-light: #f8f8f8;
            --color-background: #f8f9fa; /* Çok açık gri arkaplan */
            --color-card-background: #ffffff;
            --color-border-light: #dadce0; /* Hafif, modern kenarlık */
            --color-border-dark: #c1c1c1;
            --color-shadow-light: rgba(60, 64, 67, 0.1); /* Hafif gölge */
            --color-shadow-medium: rgba(60, 64, 67, 0.15); /* Orta gölge */
            --font-family-main: 'Inter', sans-serif; /* Modern, clean font */
            --spacing-xs: 8px;
            --spacing-sm: 16px;
            --spacing-md: 24px;
            --spacing-lg: 32px;
            --border-radius-sm: 8px;
            --border-radius-md: 16px;
        }

        /* Inter fontunu Google Fonts'tan dahil etme */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap'); /* 800 bold'u da ekledik */

        body {
            font-family: var(--font-family-main);
            margin: 0;
            padding: var(--spacing-lg);
            background-color: var(--color-background);
            color: var(--color-text-dark);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        h1 {
            color: var(--color-primary);
            font-size: 2.8em;
            margin-bottom: var(--spacing-lg);
            text-align: center;
            font-weight: 800; /* Daha da kalın başlık */
            letter-spacing: -0.8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        h2 {
            color: var(--color-text-dark);
            font-size: 1.8em;
            border-bottom: 2px solid var(--color-border-light);
            padding-bottom: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            font-weight: 700; /* Daha belirgin alt başlık */
            line-height: 1.3;
        }

        #app-container {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: var(--spacing-lg);
            width: 100%;
            max-width: 1400px;
        }

        .card {
            background-color: var(--color-card-background);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-md);
            box-shadow: 0 10px 30px var(--color-shadow-light);
            transition: transform 0.3s ease-out, box-shadow 0.3s ease-out;
        }
        .card:hover {
            transform: translateY(-7px);
            box-shadow: 0 15px 40px var(--color-shadow-medium);
        }

        .form-section {
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-md);
            border: 1px solid var(--color-border-light);
            border-radius: var(--border-radius-sm);
            background-color: #fcfcfc;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .form-section:last-of-type {
            margin-bottom: 0;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
        }
        .form-row.full-width {
            grid-template-columns: 1fr;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        label {
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
            font-size: 0.95em;
            color: var(--color-text-medium);
            transition: color 0.3s ease;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"], /* Tarih inputu için eklendi */
        select { /* select için de stil eklendi */
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--color-border-dark);
            border-radius: var(--border-radius-sm);
            font-size: 1.05em;
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
            background-color: #ffffff;
            appearance: none; /* Varsayılan select stilini kaldırır */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007bff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13%205.7L146.2%20202.7%2018.5%2075.1a17.6%2017.6%200%200%200-24.7%2024.7l130.4%20130.4c6.6%206.6%2017.4%206.6%2024%200l130.4-130.4a17.6%2017.6%200%200%200-12.9-30.5z%22%2F%3E%3C%2Fsvg%3E'); /* Özel aşağı ok */
            background-repeat: no-repeat;
            background-position: right var(--spacing-sm) center;
            background-size: 12px;
            padding-right: calc(var(--spacing-sm) * 2 + 12px); /* Ok için boşluk */
        }
        input[type="date"] {
            background-image: none; /* Tarih inputu için ok görselini kaldır */
            padding-right: var(--spacing-sm); /* Normal padding'e geri dön */
        }
        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus, /* Tarih inputu için eklendi */
        select:focus { /* select için de stil eklendi */
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 5px rgba(26, 115, 232, 0.2);
            background-color: #faffe0;
        }
        
        input::placeholder {
            color: #aab2bd;
            opacity: 1;
        }

        input:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
        }

        .waypoint-input {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
        }
        .waypoint-input input { flex-grow: 1; }
        .waypoint-input button {
            background-color: var(--color-accent);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.3s ease;
            flex-shrink: 0;
            opacity: 0.9;
        }
        .waypoint-input button:hover {
            background-color: #d13023;
            opacity: 1;
        }

        #addWaypoint {
            background-color: var(--color-secondary);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-weight: 500;
            display: block;
            width: 100%;
            margin-top: var(--spacing-sm);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #addWaypoint:hover {
            background-color: #2e8b4e;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }

        #returnTripSection, #weatherForecastSection {
            border: 1px dashed var(--color-border-dark);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-sm);
            background-color: #fefefe;
            margin-top: var(--spacing-md);
        }
        #returnTripSection label, #weatherForecastSection label {
            display: flex;
            align-items: center;
            margin-bottom: var(--spacing-sm);
            font-size: 1em;
            font-weight: 600;
            color: var(--color-text-dark);
        }
        #returnTripSection input[type="checkbox"], #weatherForecastSection input[type="checkbox"] {
            width: auto;
            margin-right: var(--spacing-sm);
            transform: scale(1.4);
            accent-color: var(--color-primary);
            cursor: pointer;
        }
        #returnTripSection .form-group {
            margin-top: var(--spacing-sm);
        }
        #returnTripSection #returnFuelInputGroup {
            display: none;
            margin-top: var(--spacing-sm);
        }
        #returnTripSection #returnFuelInputGroup.active {
            display: flex;
        }
        
        /* Manuel Köprü Ücreti Alanı */
        #tollFeeAdjustableGroup { /* Yeni grup için id */
            display: none; /* Başlangıçta gizli */
            margin-top: var(--spacing-md);
            border-top: 1px dashed var(--color-border-light);
            padding-top: var(--spacing-md);
        }
        #tollFeeAdjustableGroup.active {
            display: flex; /* 'active' class'ı eklendiğinde göster */
        }
        #tollFeeAdjustableGroup .form-group { /* İçindeki form-group'u flex yapısını bozmadan düzeltme */
            width: 100%;
        }


        button[type="submit"] {
            padding: var(--spacing-md) var(--spacing-lg);
            background-color: var(--color-primary);
            color: var(--color-text-light);
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 1.3em;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            margin-top: var(--spacing-md);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
            width: 100%;
        }
        button[type="submit"]:hover {
            background-color: #1565c0;
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        button[type="submit"]:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        #map {
            height: 700px;
            width: 100%;
            border: 1px solid var(--color-border-light);
            border-radius: var(--border-radius-md);
            box-shadow: 0 10px 30px var(--color-shadow-light);
        }
        
        #results {
            width: 100%;
            max-width: 1400px;
            margin-top: var(--spacing-lg);
            visibility: hidden;
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out, visibility 0.6s;
        }

        #results.visible {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            padding: var(--spacing-sm) 0;
            border-bottom: 1px solid var(--color-border-light);
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .result-item strong {
            color: var(--color-text-dark);
            font-weight: 500;
            font-size: 1.05em;
        }
        .result-value {
            font-weight: 700;
            color: var(--color-primary);
            font-size: 1.3em;
            text-align: right;
            letter-spacing: -0.2px;
        }
        .summary-results .result-value {
            font-size: 1.8em;
            color: var(--color-accent);
            font-weight: 800;
            text-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .summary-results .result-item {
            padding: var(--spacing-lg) 0;
        }

        hr {
            border: 0;
            height: 1px;
            background: var(--color-border-dark);
            margin: var(--spacing-md) 0;
        }

        /* Weather Section Styles (Yeni ve Güncel Hali) */
        #weather-results {
            width: 100%;
            max-width: 1400px;
            margin-top: var(--spacing-lg);
            visibility: hidden;
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out, visibility 0.6s;
        }

        #weather-results.visible {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }
        
        .weather-location-container {
            margin-bottom: var(--spacing-md); /* Daha az boşluk */
            padding-bottom: var(--spacing-sm); /* Daha az iç boşluk */
            border-bottom: 1px solid var(--color-border-light);
        }
        .weather-location-container:last-of-type {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .weather-location-container h3 {
            color: var(--color-primary);
            font-size: 1.4em; /* Daha küçük başlık */
            margin-top: 0;
            margin-bottom: var(--spacing-sm); /* Daha az boşluk */
            border-bottom: 1px dashed var(--color-border-light);
            padding-bottom: var(--spacing-xs);
        }


        .weather-card-container {
            display: flex; /* Flexbox ile yatay düzen */
            overflow-x: auto; /* Yatay kaydırma */
            gap: var(--spacing-sm); /* Kartlar arası daha az boşluk */
            padding-bottom: var(--spacing-xs); /* Kaydırma çubuğu için biraz boşluk */
            scrollbar-width: thin; /* Firefox için kaydırma çubuğu stili */
            scrollbar-color: var(--color-primary) var(--color-border-light); /* Firefox için renk */
        }
        /* Webkit tarayıcılar (Chrome, Safari) için kaydırma çubuğu */
        .weather-card-container::-webkit-scrollbar {
            height: 6px;
        }
        .weather-card-container::-webkit-scrollbar-track {
            background: var(--color-border-light);
            border-radius: 10px;
        }
        .weather-card-container::-webkit-scrollbar-thumb {
            background-color: var(--color-primary);
            border-radius: 10px;
            border: 1px solid var(--color-primary);
        }

        .weather-card {
            flex-shrink: 0; /* Kartların küçülmesini engelle */
            width: 120px; /* Sabit küçük genişlik */
            background-color: var(--color-card-background);
            padding: var(--spacing-xs); /* Daha da az padding */
            border-radius: var(--border-radius-sm);
            box-shadow: 0 2px 8px var(--color-shadow-light); /* Daha hafif gölge */
            text-align: center;
            font-size: 0.85em; /* Daha küçük font */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            cursor: pointer; /* Detaylar için hover etkisi */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .weather-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px var(--color-shadow-medium);
        }

        .weather-card h4 {
            margin-top: 0;
            margin-bottom: var(--spacing-xs);
            color: var(--color-text-dark);
            font-size: 1em; /* Daha küçük başlık */
            font-weight: 600;
        }

        .weather-icon {
            width: 50px; /* Daha küçük ikon */
            height: 50px;
            margin: 0 auto;
        }

        .weather-temp {
            font-size: 1.6em; /* Daha küçük sıcaklık fontu */
            font-weight: 700;
            color: var(--color-text-dark);
            margin-bottom: var(--spacing-xs);
            line-height: 1; /* Satır yüksekliğini azalt */
        }

        .weather-description {
            font-size: 0.8em; /* Daha küçük açıklama fontu */
            color: var(--color-text-medium);
            text-transform: capitalize;
            height: 2.4em; /* İki satır için sabit yükseklik */
            overflow: hidden; /* Taşmayı gizle */
            display: -webkit-box;
            -webkit-line-clamp: 2; /* Sadece 2 satır göster */
            -webkit-box-orient: vertical;
        }
        .weather-loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: var(--color-text-medium);
        }

        .weather-info-message {
            font-size: 0.9em;
            color: var(--color-text-medium);
            margin-top: var(--spacing-sm);
            text-align: center;
            font-style: italic;
            padding: var(--spacing-sm);
            background-color: #e3f2fd;
            border-radius: var(--border-radius-sm);
            border: 1px solid #90caf9;
        }
        
        .driver-warnings {
            background-color: #ffe0b2; /* Hafif turuncu tonu */
            border: 1px solid #ff9800; /* Turuncu kenarlık */
            border-radius: var(--border-radius-sm);
            padding: var(--spacing-sm);
            margin-top: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            font-size: 0.95em;
            color: #e65100; /* Koyu turuncu metin */
            font-weight: 500;
        }
        .driver-warnings ul {
            margin: 0;
            padding-left: var(--spacing-md);
            list-style: disc;
        }
        .driver-warnings li {
            margin-bottom: var(--spacing-xs);
        }
        .driver-warnings li:last-child {
            margin-bottom: 0;
        }
        
        /* Optimize Edilmiş Rota Sırası Yeni Stiller */
        #optimizedRouteOrder {
            width: 100%;
            margin-top: 10px;
            margin-bottom: 10px;
            background-color: var(--color-background); /* Arka planı biraz farklı */
            border-radius: var(--border-radius-sm);
            padding: var(--spacing-sm);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }

        #optimizedRouteOrder ul {
            list-style: none; /* Varsayılan list stilini kaldır */
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs); /* Liste öğeleri arasında boşluk */
        }

        #optimizedRouteOrder li {
            display: flex;
            align-items: center;
            position: relative; /* Çizgi için */
            padding: var(--spacing-xs) var(--spacing-sm);
            background-color: var(--color-card-background);
            border: 1px solid var(--color-border-light);
            border-radius: var(--border-radius-sm);
            font-size: 1.1em;
            font-weight: 500;
            color: var(--color-text-dark);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        #optimizedRouteOrder li:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        #optimizedRouteOrder li .step-number {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 28px; /* Daire genişliği */
            height: 28px; /* Daire yüksekliği */
            background-color: var(--color-primary);
            color: var(--color-text-light);
            border-radius: 50%; /* Daire şekli */
            font-weight: 700;
            font-size: 0.8em;
            margin-right: var(--spacing-sm);
            flex-shrink: 0; /* Küçülmesini engelle */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease;
        }

        #optimizedRouteOrder li:first-child .step-number {
            background-color: var(--color-secondary); /* Başlangıç için farklı renk */
        }

        #optimizedRouteOrder li:last-child .step-number {
            background-color: var(--color-accent); /* Bitiş için farklı renk */
        }

        #optimizedRouteOrder li .location-name {
            flex-grow: 1; /* Konum adının kalan alanı doldurmasını sağla */
            white-space: nowrap; /* Metni tek satırda tut */
            overflow: hidden; /* Taşmayı gizle */
            text-overflow: ellipsis; /* Taşma durumunda üç nokta göster */
        }

        #optimizedRouteOrder li .location-tag {
            font-size: 0.85em;
            color: var(--color-text-medium);
            font-weight: 400;
            margin-left: var(--spacing-xs);
            padding: 2px 6px;
            background-color: #f0f0f0;
            border-radius: 4px;
        }

        /* Liste öğeleri arasına çizgi ekleme */
        #optimizedRouteOrder li:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 19px; /* Numara dairenin ortasına hizala */
            bottom: -8px; /* Bir sonraki öğeye doğru düşey çizgi */
            width: 2px;
            height: var(--spacing-xs); /* Çizgi yüksekliği */
            background-color: var(--color-border-dark);
            z-index: -1; /* Arka planda kalmasını sağla */
        }

        /* Duyarlı Tasarım */
        @media (max-width: 992px) {
            #app-container {
                grid-template-columns: 1fr;
            }
            form {
                gap: var(--spacing-sm);
            }
            .form-row {
                grid-template-columns: 1fr;
                gap: var(--spacing-sm);
            }
            #map {
                height: 300px;
            }
            h1 {
                font-size: 2.2em;
                margin-bottom: var(--spacing-md);
            }
            body {
                padding: var(--spacing-md);
            }
            .card {
                padding: var(--spacing-md);
            }
            button[type="submit"] {
                font-size: 1.2em;
                padding: var(--spacing-sm) var(--spacing-md);
            }
            .form-section {
                padding: var(--spacing-sm);
            }
            #results, #weather-results {
                margin-top: var(--spacing-md);
            }
            .summary-results .result-value {
                font-size: 1.5em;
            }
            /* Hava durumu kartları mobilde daha az küçülür */
            .weather-card-container {
                gap: var(--spacing-xs);
            }
            .weather-card {
                width: 100px; /* Mobilde de okunabilir genişlik */
                font-size: 0.8em;
            }
            .weather-card h4 {
                font-size: 0.9em;
            }
            .weather-icon {
                width: 40px;
                height: 40px;
            }
            .weather-temp {
                font-size: 1.4em;
            }
            .weather-description {
                font-size: 0.75em;
            }
            /* Rota sırası için mobil uyum */
            #optimizedRouteOrder li {
                font-size: 1em;
                padding: var(--spacing-xs);
            }
            #optimizedRouteOrder li .step-number {
                width: 24px;
                height: 24px;
                font-size: 0.75em;
                margin-right: var(--spacing-xs);
            }
            #optimizedRouteOrder li::after {
                left: 17px;
            }
        }
    </style>
</head>
<body>
    <h1>NAKLİYE FİYATI HESAPLAMA ARACI</h1>

    <div id="app-container">
        <div class="card">
            <form id="costForm">
                <div class="form-section">
                    <h2>Rota Bilgileri</h2>
                    <div class="form-row full-width">
                        <div class="form-group">
                            <label for="origin">Başlangıç Noktası</label>
                            <input type="text" id="origin" placeholder="Örn: Ankara" required>
                        </div>
                    </div>
                    <div class="form-row full-width">
                        <div class="form-group">
                            <label for="destination">Bitiş Noktası</label>
                            <input type="text" id="destination" placeholder="Örn: Samsun" required>
                        </div>
                    </div>
                    <div class="form-row full-width">
                        <div class="form-group">
                            <label>Ara Duraklar</label>
                            <div id="waypointsContainer">
                                </div>
                            <button type="button" id="addWaypoint">+ Ara Durak Ekle</button>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2>Süre ve Maliyet Parametreleri</h2>
                     <div class="form-row full-width">
                        <div class="form-group">
                            <label for="loadingDate">Tahmini Yükleme Tarihi</label>
                            <input type="date" id="loadingDate" required>
                        </div>
                    </div>
                    <div class="form-row full-width">
                        <div class="form-group">
                            <label for="vehicleType">Araç Tipi Seçimi</label>
                            <select id="vehicleType" required>
                                <option value="custom">Özel (Manuel Giriş)</option>
                                <option value="heavyTruck">Ağır Yük Tırı (26 Ton)</option>
                                <option value="mediumTruck">Orta Boy Kamyon (21 Ton)</option>
                                <option value="lightTruck">Hafif Kamyonet (19 Ton)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="loadingTime">Yükleme Süresi (saat)</label>
                            <input type="number" id="loadingTime" value="1" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="unloadingTime">İndirme Süresi (saat)</label>
                            <input type="number" id="unloadingTime" value="1" min="0" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dailyTruckFixedCostInput">Günlük Araç Sabit Maliyeti (TL)</label>
                            <input type="number" id="dailyTruckFixedCostInput" value="5900" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="otherDailyFixedCostInput">Diğer Sabit Giderler (Günlük, TL)</label>
                            <input type="number" id="otherDailyFixedCostInput" value="0" min="0" step="0.01" required>
                        </div>
                    </div>
                     <div class="form-row">
                        <div class="form-group">
                            <label for="averageSpeed">Ortalama Sürüş Hızı (km/sa)</label>
                            <input type="number" id="averageSpeed" value="75" min="1" step="0.01" required>
                        </div>
                         <div class="form-group">
                            <label for="tollBridgeSelect">Tahmini Otoyol/Köprü Seçimi</label>
                            <select id="tollBridgeSelect" required>
                                <option value="none">Hiçbiri / Yok</option>
                                <option value="15Temmuz">15 Temmuz Şehitler Köprüsü</option>
                                <option value="FSM">Fatih Sultan Mehmet Köprüsü</option>
                                <option value="YSS">Yavuz Sultan Selim Köprüsü</option>
                                <option value="Osmangazi">Osmangazi Köprüsü</option>
                                <option value="1915Canakkale">1915 Çanakkale Köprüsü</option>
                                <option value="manual">Diğer (Manuel Giriş)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row full-width" id="tollFeeAdjustableGroup">
                        <div class="form-group">
                            <label for="currentTollFeeInput">Köprü/Otoyol Ücreti (TL) <span id="tollFeeNote"></span></label>
                            <input type="number" id="currentTollFeeInput" value="0" min="0" step="0.01" required>
                        </div>
                    </div>

                    <div class="form-row full-width">
                        <div class="form-group">
                            <label for="truckTonnageInput">Araç Tonaj Kapasitesi (Ton)</label>
                            <input type="number" id="truckTonnageInput" value="26" min="1" step="0.01" required>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2>Yakıt ve Kar Bilgileri</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dieselPriceInput">Motorin Litre Fiyatı (TL)</label>
                            <input type="number" id="dieselPriceInput" value="47" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="fuelConsumptionInput">100 km'de Yakıt (Litre)</label>
                            <input type="number" id="fuelConsumptionInput" value="36" min="0" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="profitMarginInput">Kar Oranı (%)</label>
                            <input type="number" id="profitMarginInput" value="40" min="0" step="0.01" required>
                        </div>
                        <div></div>
                    </div>
                    <div id="returnTripSection">
                        <label>
                            <input type="checkbox" id="includeReturnTrip" checked>
                            Dönüş Yolu Maliyetini Dahil Et
                        </label>
                        <div class="form-group" id="returnFuelInputGroup">
                            <label for="returnTripEmptyFuelConsumption">Dönüş Yolu Boş Yakıt Tük. (100km'de Litre)</label>
                            <input type="number" id="returnTripEmptyFuelConsumption" value="28" min="0" step="0.01" required>
                        </div>
                    </div>
                    <div id="weatherForecastSection" style="margin-top: var(--spacing-md); border: 1px dashed var(--color-border-dark); padding: var(--spacing-md); border-radius: var(--border-radius-sm); background-color: #fefefe;">
                        <label>
                            <input type="checkbox" id="includeWeatherForecast">
                            Hava Durumu Tahmini Ekle
                        </label>
                    </div>
                </div>
                
                <button type="submit">Maliyet ve Karı Hesapla</button>
            </form>
        </div>

        <div id="map" class="card"></div>
    </div>

    <div id="results" class="card">
        <h2>Hesaplama Sonuçları:</h2>
        <div class="result-item">
            <strong>Optimize Edilmiş Rota Sırası:</strong>
            <div id="optimizedRouteOrder">
                <ul></ul>
            </div>
        </div>
        <hr>
        <div class="result-item">
            <strong>Rota Mesafesi (Gidiş):</strong> <span id="distance" class="result-value"></span>
        </div>
        <div class="result-item">
            <strong>Google Tahmini Sürüş Süresi:</strong> <span id="googleTravelDuration" class="result-value"></span>
        </div>
        <div class="result-item">
            <strong>Molalar Dahil Tahmini Sürüş Süresi:</strong> <span id="calculatedTravelDurationWithBreaks" class="result-value"></span>
        </div>
        <div class="result-item">
            <strong>Verilecek Tahmini Mola Sayısı:</strong> <span id="numberOfBreaks" class="result-value"></span>
        </div>
        <div class="result-item">
            <strong>Toplam Mola Süresi:</strong> <span id="totalBreakDuration" class="result-value"></span>
        </div>
        <div class="result-item">
            <strong>Toplam Operasyon Süresi (Yükleme/İndirme Dahil):</strong> <span id="totalOperationDuration" class="result-value"></span>
        </div>
        <div class="result-item">
            <strong>Hava Durumu Etkisiyle Ortalama Hız:</strong> <span id="adjustedAverageSpeedOutput" class="result-value"></span>
        </div>
        <div class="result-item">
            <strong>Yakıt Maliyeti (Gidiş):</strong> <span id="fuelCost" class="result-value"></span>
        </div>
        <div class="result-item">
            <strong>Operasyon Süresine Göre Araç Sabit Maliyeti (Gidiş):</strong> <span id="hourlyCost" class="result-value"></span>
        </div>
        <div class="result-item">
            <strong>Dönüş Yolu Maliyeti (Tahmini):</strong> <span id="returnTripCost" class="result-value"></span>
        </div>
        <hr>
        <div class="result-item">
            <strong>Kar Öncesi Temel Operasyonel Maliyet:</strong> <span id="baseOperationalCostOutput" class="result-value"></span>
        </div>
        <div class="result-item">
            <strong>Kar Dahil Operasyonel Fiyat:</strong> <span id="priceBeforeExtraCostsOutput" class="result-value"></span>
        </div>
        <div class="result-item">
            <strong>Eklenen Otoyol/Köprü Ücretleri:</strong> <span id="tollFeeOutput" class="result-value"></span>
        </div>
        <div class="result-item">
            <strong>Eklenen Diğer Sabit Giderler:</strong> <span id="otherDailyFixedCostOutput" class="result-value"></span>
        </div>
        <hr>
        <div class="result-item summary-results">
            <strong>Toplam Tahmini Araç Maliyeti:</strong> <span id="totalCost" class="result-value"></span>
        </div>
        <div class="result-item summary-results">
            <strong>Kar Dahil Nihai Fiyat:</strong> <span id="finalPriceWithProfit" class="result-value"></span>
        </div>
        <div class="result-item summary-results">
            <strong>Ton Başına Maliyet (Kar Dahil):</strong> <span id="pricePerTon" class="result-value"></span>
        </div>
    </div>

    <div id="weather-results" class="card">
        <h2>Hava Durumu Bilgileri:</h2>
        <div class="weather-info-message" id="weatherInfoMessage"></div>
        <div class="driver-warnings" id="driverWarnings">
            <h3>Sürücü Uyarıları:</h3>
            <ul id="warningList">
                </ul>
        </div>
        <div id="allWeatherLocationsContainer">
            <div class="weather-loading">Hava durumu verileri yükleniyor...</div>
        </div>
    </div>

    <script>
        let map;
        let directionsService;
        let directionsRenderer;
        let geocoder; // Geocoder servisini ekledik
        let waypointCount = 0;

        // API anahtarlarınız!
        // **ÖNEMLİ:** Gerçek projelerde bu anahtarları doğrudan HTML içinde bırakmayın.
        // Sunucu tarafında yönetin veya ortam değişkenleri kullanın.
        const GOOGLE_API_KEY = 'AIzaSyD-l-Nep9OY0HyGIe074LmZVFazxXqCLX8'; // Buraya kendi Google API anahtarınızı yapıştırın
        const OPENWEATHER_API_KEY = 'e1e99820b273b2662aa3129d96cfb0c3'; // Buraya kendi OpenWeather API anahtarınızı yapıştırın

        const MAX_DRIVE_HOURS_PER_DAY = 9; // Saat - Bir tırın günlük yasal sürüş süresi
        const BREAK_DURATION_MINUTES = 45; // Dakika - Her 4.5 saat sürüş sonrası mola süresi
        const DRIVING_INTERVAL_BEFORE_BREAK_HOURS = 4.5; // Saat - Mola öncesi sürüş süresi
        const OPENWEATHER_FORECAST_DAYS_LIMIT = 5; // OpenWeatherMap'in ücretsiz tahmin limiti (5 gün)
        const OPENWEATHER_FORECAST_INTERVAL_HOURS = 3; // OpenWeatherMap'in tahmin verdiği saat aralığı

        // Yıl sonu güncellenecek köprü ücretleri
        const bridgeTolls = {
            'none': 0,
            '15Temmuz': 351.00,
            'FSM': 351.00,
            'YSS': 630.00,
            'Osmangazi': 2530.00,
            '1915Canakkale': 3755.00
        };

        // Hava durumu koşullarına göre hız azaltma faktörleri ve uyarı mesajları
        const WEATHER_IMPACTS = {
            'clear sky': { speedFactor: 1.0, warning: null },
            'few clouds': { speedFactor: 1.0, warning: null },
            'scattered clouds': { speedFactor: 0.98, warning: null },
            'broken clouds': { speedFactor: 0.95, warning: null },
            'shower rain': { speedFactor: 0.80, warning: 'Şiddetli yağışlar bekleniyor! Yol kaygan olabilir.' },
            'rain': { speedFactor: 0.85, warning: 'Yağmur bekleniyor. Hızınızı düşürün ve dikkatli olun.' },
            'thunderstorm': { speedFactor: 0.65, warning: 'Fırtına ve şimşek uyarısı! Mümkünse güvenli bir yerde bekleyin.' },
            'snow': { speedFactor: 0.70, warning: 'Kar yağışı bekleniyor! Buzlanma riski ve düşük görüş mesafesine dikkat edin.' },
            'mist': { speedFactor: 0.90, warning: 'Hafif sis bekleniyor. Görüş mesafesi düşebilir.' },
            'haze': { speedFactor: 0.90, warning: 'Puslu hava bekleniyor. Görüş mesafesi düşebilir.' },
            'fog': { speedFactor: 0.75, warning: 'Yoğun sis uyarısı! Görüş mesafesi çok düşük olabilir.' },
            'squalls': { speedFactor: 0.65, warning: 'Kuvvetli rüzgarlar bekleniyor! Yoldan savrulma riskine dikkat edin.' },
            'tornado': { speedFactor: 0.40, warning: 'Tornado riski! Güvenli bir sığınak bulunması önerilir.' },
            'extreme': { speedFactor: 0.50, warning: 'Aşırı hava koşulları bekleniyor! Seyahat riskli olabilir.' },
            // Diğer potansiyel OpenWeatherMap durumları için varsayılan bir değer eklenebilir
            'overcast clouds': { speedFactor: 0.95, warning: null } // Örnek olarak eklendi
        };

        // Araç Profilleri Tanımları
        const vehicleProfiles = {
            'custom': { // Manuel giriş için varsayılan boş veya mevcut değerleri temsil eder
                dailyTruckFixedCost: 5900,
                averageSpeed: 75,
                truckTonnageCapacity: 26,
                fuelConsumption: 36,
                returnTripEmptyFuelConsumption: 32
            },
            'heavyTruck': {
                dailyTruckFixedCost: 5860, // Daha büyük tır için maliyet yüksek olabilir
                averageSpeed: 70, // Daha yavaş olabilir
                truckTonnageCapacity: 26,
                fuelConsumption: 40, // Daha fazla yakar
                returnTripEmptyFuelConsumption: 32
            },
            'mediumTruck': {
                dailyTruckFixedCost: 6500,
                averageSpeed: 65,
                truckTonnageCapacity: 22,
                fuelConsumption: 34,
                returnTripEmptyFuelConsumption: 28
            },
            'lightTruck': {
                dailyTruckFixedCost: 6500,
                averageSpeed: 60,
                truckTonnageCapacity: 15,
                fuelConsumption: 28,
                returnTripEmptyFuelConsumption: 20
            }
        };


        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 7,
                center: { lat: 39.0, lng: 35.0 } // Türkiye'nin yaklaşık merkezi
            });
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({ map: map });
            geocoder = new google.maps.Geocoder(); // Geocoder'ı başlattık
            toggleReturnFuelInput();
            initializeAutocomplete(); // Adres tamamlama başlat
            setTodayAsMinDate(); // Tarih inputu için minimum tarihi ayarla
            setupTollBridgeSelection(); // Köprü seçimini ayarla
            setupVehicleTypeSelection(); // Araç tipi seçimini ayarla
            setupWeatherForecastToggle(); // Hava durumu tahminini aç/kapa
        }

        function setTodayAsMinDate() {
            const loadingDateInput = document.getElementById('loadingDate');
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Ay 0-11 arası, +1 ekle
            const day = String(today.getDate()).padStart(2, '0');
            const formattedToday = `${year}-${month}-${day}`;
            loadingDateInput.setAttribute('min', formattedToday);
            loadingDateInput.value = formattedToday; // Varsayılan olarak bugünü seçili yap
        }

        function initializeAutocomplete() {
            const originInput = document.getElementById('origin');
            const destinationInput = document.getElementById('destination');

            new google.maps.places.Autocomplete(originInput, { componentRestrictions: { country: 'tr' } });
            new google.maps.places.Autocomplete(destinationInput, { componentRestrictions: { country: 'tr' } });

            // Ara duraklar için dinamik autocomplete
            document.getElementById('waypointsContainer').addEventListener('DOMNodeInserted', function(event) {
                if (event.target.classList && event.target.classList.contains('waypoint-input')) {
                    const inputField = event.target.querySelector('.waypoint-input-field');
                    if (inputField) {
                        new google.maps.places.Autocomplete(inputField, { componentRestrictions: { country: 'tr' } });
                    }
                }
            });
        }


        document.getElementById('addWaypoint').addEventListener('click', function() {
            const container = document.getElementById('waypointsContainer');
            const newWaypointDiv = document.createElement('div');
            newWaypointDiv.classList.add('waypoint-input');
            const newWaypointInput = document.createElement('input');
            newWaypointInput.type = 'text';
            newWaypointInput.classList.add('waypoint-input-field');
            newWaypointInput.placeholder = `Ara Durak ${waypointCount + 1}`;
            newWaypointInput.required = true; // Dinamik olarak eklenen inputlara da required ekledik

            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.classList.add('remove-waypoint');
            removeButton.textContent = 'X';

            newWaypointDiv.appendChild(newWaypointInput);
            newWaypointDiv.appendChild(removeButton);
            container.appendChild(newWaypointDiv);
            waypointCount++;

            // Yeni eklenen input için autocomplete'i başlat
            new google.maps.places.Autocomplete(newWaypointInput, { componentRestrictions: { country: 'tr' } });

            removeButton.addEventListener('click', function() {
                container.removeChild(newWaypointDiv);
                waypointCount--;
                // Placeholder numaralarını güncelle
                Array.from(container.children).forEach((el, index) => {
                    el.querySelector('.waypoint-input-field').placeholder = `Ara Durak ${index + 1}`;
                });
            });
        });

        document.getElementById('includeReturnTrip').addEventListener('change', toggleReturnFuelInput);

        function toggleReturnFuelInput() {
            const includeReturnTrip = document.getElementById('includeReturnTrip').checked;
            const returnFuelInputGroup = document.getElementById('returnFuelInputGroup');
            if (includeReturnTrip) {
                returnFuelInputGroup.classList.add('active');
                returnFuelInputGroup.querySelector('input').setAttribute('required', 'required');
            } else {
                returnFuelInputGroup.classList.remove('active');
                returnFuelInputGroup.querySelector('input').removeAttribute('required');
            }
        }

        function setupWeatherForecastToggle() {
            const includeWeatherForecastCheckbox = document.getElementById('includeWeatherForecast');
            const weatherResultsDiv = document.getElementById('weather-results');

            // İlk başta hava durumu sonuçlarını gizle
            weatherResultsDiv.classList.remove('visible');

            includeWeatherForecastCheckbox.addEventListener('change', function() {
                if (!this.checked) {
                    // Checkbox işaretli değilse hava durumu sonuçlarını gizle
                    weatherResultsDiv.classList.remove('visible');
                    // Ayrıca, hava durumu ile ilgili uyarı ve mesajları da temizleyelim
                    document.getElementById('allWeatherLocationsContainer').innerHTML = '';
                    document.getElementById('weatherInfoMessage').textContent = '';
                    document.getElementById('warningList').innerHTML = '';
                    document.getElementById('driverWarnings').style.display = 'none';
                }
                // İşaretli olduğunda otomatik olarak gösterilmeyecek, hesaplama tetiklendiğinde gösterilecek.
                // Bu kısım boş kalacak çünkü görünürlük hesaplama anında ayarlanacak.
            });
        }

        function setupTollBridgeSelection() {
            const tollBridgeSelect = document.getElementById('tollBridgeSelect');
            const tollFeeAdjustableGroup = document.getElementById('tollFeeAdjustableGroup');
            const currentTollFeeInput = document.getElementById('currentTollFeeInput');
            const tollFeeNote = document.getElementById('tollFeeNote'); 

            function updateTollFeeInput() {
                const selectedBridge = tollBridgeSelect.value;

                if (selectedBridge === 'none') {
                    tollFeeAdjustableGroup.classList.remove('active');
                    currentTollFeeInput.value = 0;
                    currentTollFeeInput.disabled = true;
                    currentTollFeeInput.required = false;
                    tollFeeNote.textContent = '';
                } else if (selectedBridge === 'manual') {
                    tollFeeAdjustableGroup.classList.add('active');
                    currentTollFeeInput.value = 0; 
                    currentTollFeeInput.disabled = false;
                    currentTollFeeInput.required = true;
                    currentTollFeeInput.focus();
                    tollFeeNote.textContent = '(Manuel Giriş)';
                } else {
                    const fee = bridgeTolls[selectedBridge];
                    currentTollFeeInput.value = fee;
                    currentTollFeeInput.disabled = false;
                    currentTollFeeInput.required = true;
                    tollFeeAdjustableGroup.classList.add('active');
                    tollFeeNote.textContent = `(2025 Güncel)`; 
                }
            }

            tollBridgeSelect.addEventListener('change', updateTollFeeInput);
            updateTollFeeInput(); 
        }

        function setupVehicleTypeSelection() {
            const vehicleTypeSelect = document.getElementById('vehicleType');
            const dailyTruckFixedCostInput = document.getElementById('dailyTruckFixedCostInput');
            const averageSpeedInput = document.getElementById('averageSpeed');
            const truckTonnageInput = document.getElementById('truckTonnageInput');
            const fuelConsumptionInput = document.getElementById('fuelConsumptionInput');
            const returnTripEmptyFuelConsumptionInput = document.getElementById('returnTripEmptyFuelConsumption');

            vehicleTypeSelect.addEventListener('change', function() {
                const selectedType = this.value;
                const profile = vehicleProfiles[selectedType];

                if (selectedType === 'custom') {
                    // Özel seçildiğinde tüm alanları düzenlenebilir yap
                    dailyTruckFixedCostInput.disabled = false;
                    averageSpeedInput.disabled = false;
                    truckTonnageInput.disabled = false;
                    fuelConsumptionInput.disabled = false;
                    returnTripEmptyFuelConsumptionInput.disabled = false;
                    // Değerleri temizle veya mevcut değerleri koru (tercihe bağlı)
                    // dailyTruckFixedCostInput.value = '';
                    // averageSpeedInput.value = '';
                    // truckTonnageInput.value = '';
                    // fuelConsumptionInput.value = '';
                    // returnTripEmptyFuelConsumptionInput.value = '';
                } else {
                    // Profil seçildiğinde alanları doldur ve devre dışı bırak
                    dailyTruckFixedCostInput.value = profile.dailyTruckFixedCost;
                    averageSpeedInput.value = profile.averageSpeed;
                    truckTonnageInput.value = profile.truckTonnageCapacity;
                    fuelConsumptionInput.value = profile.fuelConsumption;
                    returnTripEmptyFuelConsumptionInput.value = profile.returnTripEmptyFuelConsumption;

                    dailyTruckFixedCostInput.disabled = true;
                    averageSpeedInput.disabled = true;
                    truckTonnageInput.disabled = true;
                    fuelConsumptionInput.disabled = true;
                    returnTripEmptyFuelConsumptionInput.disabled = true;
                }
            });

            // Sayfa yüklendiğinde varsayılan profili uygula (genellikle "custom" veya ilk seçenek)
            vehicleTypeSelect.dispatchEvent(new Event('change'));
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('tr-TR', {
                style: 'currency',
                currency: 'TRY', 
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function formatNumber(num, decimalPlaces = 0) {
            return new Intl.NumberFormat('tr-TR', {
                minimumFractionDigits: decimalPlaces,
                maximumFractionDigits: decimalPlaces
            }).format(num);
        }

        // --- Hava Durumu Verilerini Getirme ve Gösterme (Güncellendi) ---
        async function fetchWeatherForLocation(lat, lon, locationName, referenceDate, journeyStartTimeInSec) {
            const today = new Date();
            today.setHours(0,0,0,0);
            const selectedDate = new Date(referenceDate);
            selectedDate.setHours(0,0,0,0);
            
            const diffTime = Math.abs(selectedDate - today);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

            let locationHtml = '';
            let locationDriverWarnings = [];
            let allForecastsForLocation = []; // Bu konum için tüm tahminleri tutarız

            if (diffDays > OPENWEATHER_FORECAST_DAYS_LIMIT) {
                return {
                    cardsHtml: `<div class="weather-card"><h4>${locationName}</h4><p>Tahmin ${OPENWEATHER_FORECAST_DAYS_LIMIT} gün sonrasına kadar mevcuttur.</p></div>`,
                    overallSpeedFactor: 1.0,
                    warnings: [`Dikkat: ${locationName} için hava durumu tahmini ${OPENWEATHER_FORECAST_DAYS_LIMIT} günden fazla ileriye bakılamaz.`],
                    isForecastAvailable: false,
                    allForecasts: []
                };
            }

            try {
                const response = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${OPENWEATHER_API_KEY}&units=metric&lang=tr`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                allForecastsForLocation = data.list; // Tüm 3 saatlik tahminleri kaydet

                locationHtml += `<h3>${locationName}</h3><div class="weather-card-container">`;

                // Sadece yükleme tarihinden itibaren ilk 24 saatlik tahminleri göster
                // Bu örnek için 8 adet 3 saatlik tahmin kartı (24 saat) yeterli olacaktır.
                const relevantForecasts = data.list.filter(item => {
                    const itemDate = new Date(item.dt_txt);
                    return itemDate.toDateString() === selectedDate.toDateString() || itemDate.toDateString() === new Date(selectedDate.getTime() + (24 * 60 * 60 * 1000)).toDateString(); 
                }).slice(0, 8); 

                if (relevantForecasts.length > 0) {
                    relevantForecasts.forEach(item => {
                        const description = item.weather[0].description.toLowerCase();
                        const iconUrl = `https://openweathermap.org/img/wn/${item.weather[0].icon}@2x.png`;
                        const temp = Math.round(item.main.temp);
                        const time = new Date(item.dt * 1000).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });

                        locationHtml += `
                            <div class="weather-card">
                                <h4>${time}</h4>
                                <img src="${iconUrl}" alt="${description}" class="weather-icon">
                                <div class="weather-temp">${temp}°C</div>
                                <div class="weather-description">${description}</div>
                            </div>
                        `;

                        // Uyarıları topla
                        const impact = WEATHER_IMPACTS[description] || { speedFactor: 1.0, warning: null };
                        if (impact.warning) {
                            locationDriverWarnings.push(`<strong>${locationName} - ${time}:</strong> ${impact.warning}`);
                        }
                    });
                } else {
                    locationHtml += `<div class="weather-card"><p>Seçilen güne ait detaylı hava durumu tahmini bulunamadı.</p></div>`;
                }

                locationHtml += `</div>`; // .weather-card-container kapanışı

                return {
                    cardsHtml: locationHtml,
                    overallSpeedFactor: 1.0, 
                    warnings: locationDriverWarnings,
                    isForecastAvailable: true,
                    allForecasts: allForecastsForLocation 
                };

            } catch (error) {
                console.error(`Hava durumu verisi çekilirken hata oluştu (${locationName}):`, error);
                return {
                    cardsHtml: `<div class="weather-card"><h3>${locationName}</h3><p>Hava durumu bilgisi alınamadı.</p></div>`,
                    overallSpeedFactor: 1.0,
                    warnings: [`Hata: ${locationName} için hava durumu bilgisi alınamadı.`],
                    isForecastAvailable: false,
                    allForecasts: []
                };
            }
        }
        // --- Fonksiyon Sonu ---


        document.getElementById('costForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const origin = document.getElementById('origin').value.trim();
            const destination = document.getElementById('destination').value.trim();
            const loadingDate = document.getElementById('loadingDate').value; 
            const loadingTime = parseFloat(document.getElementById('loadingTime').value) || 0;
            const unloadingTime = parseFloat(document.getElementById('unloadingTime').value) || 0;
            const dailyTruckFixedCost = parseFloat(document.getElementById('dailyTruckFixedCostInput').value) || 0;
            
            const tollFee = parseFloat(document.getElementById('currentTollFeeInput').value) || 0;

            const otherDailyFixedCost = parseFloat(document.getElementById('otherDailyFixedCostInput').value) || 0;
            const dieselPricePerLiter = parseFloat(document.getElementById('dieselPriceInput').value) || 0;
            const fuelConsumptionPer100Km = parseFloat(document.getElementById('fuelConsumptionInput').value) || 0;
            const truckTonnageCapacity = parseFloat(document.getElementById('truckTonnageInput').value) || 0;
            const profitMargin = parseFloat(document.getElementById('profitMarginInput').value) || 0;
            let initialAverageSpeed = parseFloat(document.getElementById('averageSpeed').value) || 0; 

            const includeReturnTrip = document.getElementById('includeReturnTrip').checked;
            let returnTripEmptyFuelConsumption = 0;
            if (includeReturnTrip) {
                returnTripEmptyFuelConsumption = parseFloat(document.getElementById('returnTripEmptyFuelConsumption').value) || 0;
            }
            const includeWeatherForecast = document.getElementById('includeWeatherForecast').checked;


            // --- Giriş Doğrulamaları ---
            if (!origin || !destination || !loadingDate) { 
                alert('Başlangıç, Bitiş noktaları ve Yükleme Tarihi boş bırakılamaz.');
                return;
            }
            if (isNaN(loadingTime) || isNaN(unloadingTime) || isNaN(dailyTruckFixedCost) || isNaN(otherDailyFixedCost) ||
                isNaN(dieselPricePerLiter) || isNaN(fuelConsumptionPer100Km) ||
                isNaN(truckTonnageCapacity) || isNaN(profitMargin) || isNaN(tollFee) ||
                isNaN(initialAverageSpeed) || loadingTime < 0 || unloadingTime < 0 ||
                dailyTruckFixedCost < 0 || otherDailyFixedCost < 0 || dieselPricePerLiter < 0 || fuelConsumptionPer100Km < 0 ||
                truckTonnageCapacity <= 0 || profitMargin < 0 || tollFee < 0 || initialAverageSpeed <= 0) {
                alert('Lütfen tüm alanlara geçerli, pozitif sayısal değerler girin. Tonaj kapasitesi ve Ortalama Hız 0\'dan büyük olmalıdır.');
                return;
            }
            if (includeReturnTrip && (isNaN(returnTripEmptyFuelConsumption) || returnTripEmptyFuelConsumption < 0)) {
                alert('Dönüş yolu maliyeti dahil edildiğinde, boş yakıt tüketimi geçerli bir sayı olmalıdır.');
                return;
            }
            // --- Doğrulama Sonu ---

            const HOURLY_TRUCK_FIXED_COST = dailyTruckFixedCost / MAX_DRIVE_HOURS_PER_DAY;


            const waypoints = [];
            // Dynamik olarak eklenen waypoint inputlarını topla
            document.querySelectorAll('.waypoint-input-field').forEach(input => {
                const waypointValue = input.value.trim();
                if (waypointValue) {
                    waypoints.push({ location: waypointValue, stopover: true });
                }
            });

            const request = {
                origin: origin,
                destination: destination,
                waypoints: waypoints,
                optimizeWaypoints: true, 
                travelMode: google.maps.TravelMode.DRIVING
            };

            const resultsElement = document.getElementById('results');
            const weatherResultsDiv = document.getElementById('weather-results');
            const allWeatherLocationsContainer = document.getElementById('allWeatherLocationsContainer'); 
            const weatherInfoMessage = document.getElementById('weatherInfoMessage');
            const driverWarningsDiv = document.getElementById('driverWarnings');
            const warningList = document.getElementById('warningList');
            const optimizedRouteOrderList = document.getElementById('optimizedRouteOrder').querySelector('ul');


            // Sonuçları ve hava durumu bilgilerini gizle ve yükleniyor mesajını göster
            resultsElement.classList.remove('visible');
            // Hava durumu tahmini seçili değilse, ilgili bölümleri tamamen temizle ve gizle
            if (!includeWeatherForecast) {
                weatherResultsDiv.classList.remove('visible');
                allWeatherLocationsContainer.innerHTML = ''; // İçeriği tamamen temizle
                weatherInfoMessage.textContent = '';
                warningList.innerHTML = '';
                driverWarningsDiv.style.display = 'none';
            } else {
                // Hava durumu seçiliyse, yükleniyor mesajını göster
                weatherResultsDiv.classList.remove('visible'); // Başlangıçta gizle
                allWeatherLocationsContainer.innerHTML = '<div class="weather-loading">Hava durumu verileri yükleniyor...</div>';
                weatherInfoMessage.textContent = '';
                warningList.innerHTML = '';
                driverWarningsDiv.style.display = 'none';
            }
            optimizedRouteOrderList.innerHTML = ''; // Rota sırasını temizle


            directionsService.route(request, async function(result, status) {
                if (status === google.maps.DirectionsStatus.OK) {
                    directionsRenderer.setDirections(result);

                    const route = result.routes[0];
                    let totalDistanceInMeters = 0;
                    let googleTotalTravelDurationInSeconds = 0;
                    
                    // Rota üzerindeki tüm önemli noktaların (origin, waypoints, destination) isim ve LatLng'lerini topla
                    const locationsToQuery = [];
                    
                    // Rota sırasını HTML'e şık bir şekilde yazdır
                    optimizedRouteOrderList.innerHTML = ''; // Önceki içeriği temizle
                    
                    let currentStep = 1;
                    optimizedRouteOrderList.innerHTML += `
                        <li>
                            <span class="step-number">${currentStep++}</span>
                            <span class="location-name">${origin}</span>
                            <span class="location-tag">Başlangıç</span>
                        </li>
                    `;
                    locationsToQuery.push({ name: origin, latLng: route.legs[0].start_location });

                    // Optimize edilmiş ara durakları ekle
                    const orderedWaypoints = route.waypoint_order.map(index => waypoints[index].location);
                    orderedWaypoints.forEach((waypoint, index) => {
                         optimizedRouteOrderList.innerHTML += `
                            <li>
                                <span class="step-number">${currentStep++}</span>
                                <span class="location-name">${waypoint}</span>
                                <span class="location-tag">Ara Durak</span>
                            </li>
                        `;
                        // Hava durumu için ara durakları da ekle
                        // Google Directions API'nin döndürdüğü `leg.end_location` doğru konumları verecektir.
                        // route.legs[index] aslında `origin`'den ilk waypoint'e, ilk waypoint'ten ikinciye vb. bacakları temsil eder.
                        // Dolayısıyla leg.end_location, o bacağın bitiş noktasıdır.
                        locationsToQuery.push({ name: waypoint, latLng: route.legs[index].end_location });
                    });
                    
                    optimizedRouteOrderList.innerHTML += `
                        <li>
                            <span class="step-number">${currentStep++}</span>
                            <span class="location-name">${destination}</span>
                            <span class="location-tag">Bitiş</span>
                        </li>
                    `;
                    // Son durağın LatLng'sini ekle
                    locationsToQuery.push({ name: destination, latLng: route.legs[route.legs.length - 1].end_location });


                    route.legs.forEach((leg) => {
                        totalDistanceInMeters += leg.distance.value;
                        googleTotalTravelDurationInSeconds += leg.duration.value;
                    });
                    

                    const distanceInKm = totalDistanceInMeters / 1000;
                    
                    // --- Hava Durumu Verilerini Çekme ve Hızı Ayarlama ---
                    let allWeatherHtml = '';
                    let allDriverWarnings = [];
                    let overallMinSpeedFactor = 1.0;
                    let hasForecastError = false;
                    let adjustedAverageSpeed = initialAverageSpeed;
                    let speedAdjustmentNote = `Ortalama Sürüş Hızı: ${formatNumber(initialAverageSpeed, 0)} km/sa`;


                    if (includeWeatherForecast) { // YENİ: Hava durumu tahmini seçiliyse sorgula
                        // Her bir konum için hava durumu verilerini paralel olarak çek
                        const weatherPromises = locationsToQuery.map(loc =>
                            fetchWeatherForLocation(loc.latLng.lat(), loc.latLng.lng(), loc.name, loadingDate, googleTotalTravelDurationInSeconds)
                        );
                        const weatherResults = await Promise.all(weatherPromises);

                        weatherResults.forEach(res => {
                            allWeatherHtml += `<div class="weather-location-container">${res.cardsHtml}</div>`;
                            allDriverWarnings = allDriverWarnings.concat(res.warnings);
                            if (!res.isForecastAvailable) {
                                hasForecastError = true;
                            }

                            // Bu konumdaki tüm tahminler arasında en düşük speedFactor'ı bul ve overallMinSpeedFactor'ı güncelle
                            if (res.allForecasts && res.allForecasts.length > 0) {
                                res.allForecasts.forEach(forecastItem => {
                                    const description = forecastItem.weather[0].description.toLowerCase();
                                    const impact = WEATHER_IMPACTS[description] || { speedFactor: 1.0, warning: null };
                                    overallMinSpeedFactor = Math.min(overallMinSpeedFactor, impact.speedFactor);
                                });
                            }
                        });

                        allWeatherLocationsContainer.innerHTML = allWeatherHtml;

                        if (overallMinSpeedFactor < 1.0) {
                            adjustedAverageSpeed = initialAverageSpeed * overallMinSpeedFactor;
                            speedAdjustmentNote = `Hava şartları nedeniyle hızınız ${formatNumber(initialAverageSpeed, 0)} km/sa'ten ${formatNumber(adjustedAverageSpeed, 0)} km/sa'e düşürüldü.`;
                            weatherInfoMessage.textContent = `Rota üzerindeki kötü hava koşulları nedeniyle tahmini sürüş hızınız %${formatNumber((1 - overallMinSpeedFactor) * 100, 0)} azaltıldı.`;
                        } else if (hasForecastError) {
                             weatherInfoMessage.textContent = `Bazı konumlar için hava durumu tahmini alınamadı veya sınırlıdır. Hız ayarı buna göre yapılamamıştır.`;
                        }
                        else {
                            weatherInfoMessage.textContent = `Rota üzerinde önemli hava durumu engeli beklenmiyor.`;
                        }

                        // Sürücü uyarılarını göster
                        if (allDriverWarnings.length > 0) {
                            allDriverWarnings.forEach(warning => {
                                const li = document.createElement('li');
                                li.innerHTML = warning;
                                warningList.appendChild(li);
                            });
                            driverWarningsDiv.style.display = 'block';
                        } else {
                            driverWarningsDiv.style.display = 'none';
                        }

                        weatherResultsDiv.classList.add('visible'); // Hava durumu seçiliyse sonuçları göster
                    } else {
                        // Hava durumu tahmini seçili değilse, varsayılan değerleri kullan ve alanı gizle
                        allWeatherLocationsContainer.innerHTML = '';
                        weatherInfoMessage.textContent = 'Hava durumu tahmini devre dışı bırakıldı.';
                        warningList.innerHTML = '';
                        driverWarningsDiv.style.display = 'none';
                        weatherResultsDiv.classList.remove('visible'); // Sonuç alanını gizle
                    }
                    // --- Hava Durumu Entegrasyonu Bitti ---

                    const calculatedTravelDurationInHours = distanceInKm / adjustedAverageSpeed; 
                    
                    const numberOfDrivingIntervals = Math.floor(calculatedTravelDurationInHours / DRIVING_INTERVAL_BEFORE_BREAK_HOURS);
                    const totalBreakDurationHours = numberOfDrivingIntervals * (BREAK_DURATION_MINUTES / 60);

                    const calculatedTravelDurationWithBreaks = calculatedTravelDurationInHours + totalBreakDurationHours;

                    const totalOperationDurationInHours = calculatedTravelDurationWithBreaks + loadingTime + unloadingTime;

                    document.getElementById('distance').textContent = `${formatNumber(distanceInKm, 0)} km`;
                    document.getElementById('googleTravelDuration').textContent = `${formatNumber(googleTotalTravelDurationInSeconds / 60, 0)} dakika (${formatNumber(googleTotalTravelDurationInSeconds / 3600, 1)} saat)`;
                    document.getElementById('calculatedTravelDurationWithBreaks').textContent = `${formatNumber(calculatedTravelDurationWithBreaks, 1)} saat`;
                    document.getElementById('totalOperationDuration').textContent = `${formatNumber(totalOperationDurationInHours, 1)} saat`;
                    document.getElementById('adjustedAverageSpeedOutput').textContent = speedAdjustmentNote; 
                    
                    // YENİ: Mola Detayları
                    document.getElementById('numberOfBreaks').textContent = `${formatNumber(numberOfDrivingIntervals, 0)} mola`;
                    document.getElementById('totalBreakDuration').textContent = `${formatNumber(totalBreakDurationHours, 1)} saat`;


                    const fuelNeededPerKm = fuelConsumptionPer100Km / 100;
                    const totalFuelConsumed = distanceInKm * fuelNeededPerKm;
                    const totalFuelCost = totalFuelConsumed * dieselPricePerLiter;
                    document.getElementById('fuelCost').textContent = formatCurrency(totalFuelCost);

                    const calculatedHourlyTruckFixedCost = totalOperationDurationInHours * HOURLY_TRUCK_FIXED_COST;
                    document.getElementById('hourlyCost').textContent = formatCurrency(calculatedHourlyTruckFixedCost);

                    let totalReturnTripCost = 0;
                    if (includeReturnTrip) {
                        let returnTripFuelCost = 0;
                        if (returnTripEmptyFuelConsumption > 0) {
                            const returnFuelNeededPerKm = returnTripEmptyFuelConsumption / 100;
                            const returnTotalFuelConsumed = distanceInKm * returnFuelNeededPerKm;
                            returnTripFuelCost = returnTotalFuelConsumed * dieselPricePerLiter;
                        }
                        // Dönüş yolunda da araç sabit maliyetinin olması gerekir
                        const returnTripHourlyCost = (distanceInKm / adjustedAverageSpeed) * HOURLY_TRUCK_FIXED_COST; 
                        totalReturnTripCost = returnTripFuelCost + returnTripHourlyCost;
                    }
                    document.getElementById('returnTripCost').textContent = formatCurrency(totalReturnTripCost);

                    const baseOperationalCost = totalFuelCost + calculatedHourlyTruckFixedCost + totalReturnTripCost;
                    document.getElementById('baseOperationalCostOutput').textContent = formatCurrency(baseOperationalCost);

                    const priceBeforeExtraCosts = baseOperationalCost * (1 + (profitMargin / 100));
                    document.getElementById('priceBeforeExtraCostsOutput').textContent = formatCurrency(priceBeforeExtraCosts);
                    
                    const additionalDailyFixedCost = (otherDailyFixedCost / MAX_DRIVE_HOURS_PER_DAY) * totalOperationDurationInHours; 

                    document.getElementById('tollFeeOutput').textContent = formatCurrency(tollFee);
                    document.getElementById('otherDailyFixedCostOutput').textContent = formatCurrency(additionalDailyFixedCost);

                    // totalTruckCost'u burada tanımlıyoruz. Bu tüm maliyetlerin toplamı olabilir.
                    const totalTruckCost = totalFuelCost + calculatedHourlyTruckFixedCost + totalReturnTripCost + tollFee + additionalDailyFixedCost; 
                    
                    const finalPriceWithProfit = priceBeforeExtraCosts + tollFee + additionalDailyFixedCost;
                    document.getElementById('finalPriceWithProfit').textContent = formatCurrency(finalPriceWithProfit);
                    document.getElementById('totalCost').textContent = formatCurrency(totalTruckCost); 

                    let pricePerTon = 0;
                    if (truckTonnageCapacity > 0) {
                        pricePerTon = finalPriceWithProfit / truckTonnageCapacity;
                    }
                    document.getElementById('pricePerTon').textContent = formatCurrency(pricePerTon) + ' / Ton';

                    resultsElement.classList.add('visible');
                    resultsElement.scrollIntoView({ behavior: 'smooth', block: 'start' });

                } else {
                    alert('Rota bulunamadı veya bir hata oluştu: ' + status + '\nLütfen girilen adresleri kontrol edin.');
                    // Hata durumunda sonuçları sıfırla ve gizle
                    document.getElementById('distance').textContent = '';
                    document.getElementById('googleTravelDuration').textContent = '';
                    document.getElementById('calculatedTravelDurationWithBreaks').textContent = '';
                    document.getElementById('totalOperationDuration').textContent = '';
                    document.getElementById('adjustedAverageSpeedOutput').textContent = ''; 
                    document.getElementById('fuelCost').textContent = '';
                    document.getElementById('hourlyCost').textContent = '';
                    document.getElementById('tollFeeOutput').textContent = '';
                    document.getElementById('returnTripCost').textContent = '';
                    document.getElementById('totalCost').textContent = '';
                    document.getElementById('finalPriceWithProfit').textContent = '';
                    document.getElementById('pricePerTon').textContent = '';
                    // Yeni eklenen alanları da sıfırla
                    document.getElementById('numberOfBreaks').textContent = '';
                    document.getElementById('totalBreakDuration').textContent = '';


                    resultsElement.classList.remove('visible');

                    // Hava durumu sonuçlarını da sıfırla ve gizle
                    if (includeWeatherForecast) { // Eğer hava durumu sorgusu seçiliyse ve hata olduysa
                        document.getElementById('allWeatherLocationsContainer').innerHTML = '<div class="weather-loading">Hata: Hava durumu verileri yüklenemedi.</div>';
                        weatherResultsDiv.classList.remove('visible');
                        weatherInfoMessage.textContent = 'Hava durumu verisi alınamadı veya rota bulunamadı.';
                        warningList.innerHTML = '';
                        driverWarningsDiv.style.display = 'none';
                    } else { // Hava durumu sorgusu seçili değilse
                        document.getElementById('allWeatherLocationsContainer').innerHTML = '';
                        weatherResultsDiv.classList.remove('visible');
                        weatherInfoMessage.textContent = 'Hava durumu tahmini devre dışı bırakıldı.';
                        warningList.innerHTML = '';
                        driverWarningsDiv.style.display = 'none';
                    }
                    optimizedRouteOrderList.innerHTML = ''; 
                }
            });
        });
        document.addEventListener('DOMContentLoaded', function() {
            toggleReturnFuelInput();
            setupTollBridgeSelection(); 
            setTodayAsMinDate(); 
            setupVehicleTypeSelection(); 
            setupWeatherForecastToggle(); // DOM yüklendiğinde hava durumu toggle'ını ayarla
        });
    </script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD-l-Nep9OY0HyGIe074LmZVFazxXqCLX8&libraries=places&callback=initMap"></script>
</body>
</html>
